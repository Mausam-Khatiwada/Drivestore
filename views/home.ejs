<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
    <title>My Drive - Dashboard</title>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">
    <header class="flex justify-between items-center p-6 border-b border-gray-700 bg-gray-800 shadow-lg">
      <h1 class="text-4xl font-extrabold tracking-tight">Welcome, <%= user.username %>!</h1>
      <form action="/user/logout" method="GET" class="flex items-center">
        <button
          type="submit"
          class="flex items-center gap-2 bg-red-700 hover:bg-red-800 px-4 py-2 rounded-xl shadow-lg transition"
          aria-label="Logout"
        >
          <i class="ri-logout-box-line text-xl"></i> Logout
        </button>
      </form>
    </header>

    <main class="flex-grow p-6 max-w-7xl mx-auto w-full flex flex-col">
      <!-- Controls: Sort & Search + Upload Button -->
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8">
        <div class="flex items-center gap-4 flex-wrap w-full sm:w-auto">
          <label for="sort" class="text-gray-300 font-semibold">Sort by:</label>
          <select
            id="sort"
            name="sort"
            class="rounded-md bg-gray-700 text-gray-200 px-4 py-2 focus:outline-none shadow-inner"
            onchange="applySort(this.value)"
            aria-label="Sort files"
          >
            <option value="date_desc" selected>Upload Date (Newest)</option>
            <option value="name_asc">Name (A-Z)</option>
            <option value="size_asc">Size (Smallest)</option>
          </select>

          <input
            type="text"
            id="searchInput"
            placeholder="Search files..."
            class="bg-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none shadow-inner"
            oninput="filterFiles()"
            aria-label="Search files"
          />
        </div>

        <button
          onclick="showPopUp()"
          class="bg-blue-600 hover:bg-blue-700 transition text-white font-semibold py-3 px-6 rounded-xl shadow-lg flex items-center gap-2"
          aria-label="Upload new file"
        >
          <i class="ri-upload-cloud-2-line text-xl"></i> Upload File
        </button>
      </div>

      <!-- Files Grid -->
      <div
        id="filesGrid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
        aria-live="polite"
        aria-atomic="true"
      >
        <% if (files.length === 0) { %>
          <p class="col-span-full text-center text-gray-500 text-lg select-none">No files uploaded yet.</p>
        <% } %>
        <% files.forEach(file => { %>
          <article
            tabindex="0"
            class="file-card bg-gray-800 rounded-2xl shadow-lg shadow-black/70 hover:shadow-purple-600 hover:scale-[1.04] transition transform cursor-pointer select-text flex flex-col"
            aria-label="File: <%= file.originalName %>"
            data-name="<%= file.originalName.toLowerCase() %>"
            data-size="<%= file.size %>"
            data-date="<%= new Date(file.uploadDate).getTime() %>"
            data-path="/<%= file.path %>"
            data-mimetype="<%= file.mimeType %>"
            data-uploaddate="<%= new Date(file.uploadDate).toLocaleString() %>"
          >
            <div class="p-6 flex flex-col flex-1">
              <h3 class="text-lg font-semibold truncate mb-1"><%= file.originalName %></h3>
              <p class="text-sm text-gray-400 mb-1 truncate">Size: <%= (file.size / 1024).toFixed(2) %> KB</p>
              <p class="text-sm text-gray-400 mb-3 truncate">Type: <%= file.mimeType %></p>
              <time class="text-xs text-gray-500 mt-auto">Uploaded: <%= new Date(file.uploadDate).toLocaleString() %></time>
            </div>

            <footer class="border-t border-gray-700 p-4 flex gap-3">
              <button
                type="button"
                class="view-btn flex-1 bg-green-600 hover:bg-green-700 rounded-lg text-white py-2 text-center font-semibold shadow-md shadow-green-900/70 transition flex items-center justify-center gap-2"
                aria-label="View <%= file.originalName %>"
              >
                <i class="ri-eye-line text-lg"></i> View
              </button>
              <form action="/delete-file/<%= file._id %>" method="POST" class="flex-1">
                <button
                  type="submit"
                  class="w-full bg-red-600 hover:bg-red-700 rounded-lg text-white py-2 font-semibold shadow-md shadow-red-900/70 transition flex items-center justify-center gap-2"
                  aria-label="Delete <%= file.originalName %>"
                >
                  <i class="ri-delete-bin-line text-lg"></i> Delete
                </button>
              </form>
            </footer>
          </article>
        <% }) %>
      </div>
    </main>

    <!-- Upload Modal -->
    <div
      class="pop hidden fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="uploadModalTitle"
    >
      <div
        class="bg-gray-800 rounded-3xl shadow-lg p-6 w-full max-w-md relative animate-fade-in-up"
      >
        <button
          onclick="hidePopUp()"
          class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition text-2xl"
          aria-label="Close upload modal"
        >
          <i class="ri-close-line"></i>
        </button>
        <h3 id="uploadModalTitle" class="text-2xl font-bold text-white mb-4">Upload File</h3>
        <form
          action="/upload-file"
          method="POST"
          enctype="multipart/form-data"
          class="flex flex-col gap-4"
        >
          <label
            for="dropzone-file"
            class="flex flex-col items-center justify-center w-full h-60 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer bg-gray-700 hover:bg-gray-600 transition"
          >
            <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-300">
              <svg
                class="w-10 h-10 mb-3"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M12 12v9m0 0l-3-3m3 3l3-3M16 4h2a2 2 0 012 2v6m-6-6h-2a2 2 0 00-2 2v4"
                />
              </svg>
              <p class="text-sm font-semibold">Click to upload or drag & drop</p>
              <p class="text-xs text-gray-400 mt-1">Any file up to 5MB</p>
            </div>
            <input id="dropzone-file" type="file" name="file" class="hidden" />
          </label>
          <button
            type="submit"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-xl transition"
          >
            <i class="ri-check-line mr-2"></i> Upload File
          </button>
        </form>
      </div>
    </div>

    <!-- Preview Modal -->
    <div
      id="previewModal"
      class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="previewTitle"
    >
      <div class="bg-gray-800 rounded-3xl shadow-xl w-full max-w-3xl p-6 relative">
        <button
          id="closePreview"
          class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition text-3xl"
          aria-label="Close preview modal"
        >
          <i class="ri-close-line"></i>
        </button>

        <h2 id="previewTitle" class="text-2xl font-bold mb-4 text-white"></h2>

        <div id="previewContent" class="mb-6 text-gray-300"></div>

        <div class="flex justify-between items-center">
          <p id="previewDetails" class="text-gray-400 text-sm"></p>
          <a
            id="previewDownload"
            href="#"
            download
            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-white font-semibold transition shadow-md"
          >
            <i class="ri-download-line mr-2"></i> Download
          </a>
        </div>
      </div>
    </div>

    <script>
      // Show/hide upload modal
      function showPopUp() {
        document.querySelector('.pop').classList.remove('hidden');
      }
      function hidePopUp() {
        document.querySelector('.pop').classList.add('hidden');
      }

      // Sort & Filter logic
      const filesGrid = document.getElementById('filesGrid');
      const fileCards = Array.from(document.querySelectorAll('.file-card'));

      function applySort(sortBy) {
        let sortedFiles = [...fileCards];
        if (sortBy === 'name_asc') {
          sortedFiles.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));
        } else if (sortBy === 'size_asc') {
          sortedFiles.sort((a, b) => +a.dataset.size - +b.dataset.size);
        } else {
          // date_desc (default)
          sortedFiles.sort((a, b) => +b.dataset.date - +a.dataset.date);
        }
        filesGrid.innerHTML = '';
        sortedFiles.forEach(card => filesGrid.appendChild(card));
      }

      function filterFiles() {
        const filter = document.getElementById('searchInput').value.toLowerCase();
        fileCards.forEach(card => {
          const name = card.dataset.name;
          if (name.includes(filter)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // Preview modal logic
      const previewModal = document.getElementById('previewModal');
      const previewTitle = document.getElementById('previewTitle');
      const previewContent = document.getElementById('previewContent');
      const previewDetails = document.getElementById('previewDetails');
      const previewDownload = document.getElementById('previewDownload');
      const closePreview = document.getElementById('closePreview');

      document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', () => {
          const card = button.closest('.file-card');
          const name = card.dataset.name;
          const sizeKB = (card.dataset.size / 1024).toFixed(2);
          const mime = card.dataset.mimetype;
          const uploadDate = card.dataset.uploaddate;
          const path = card.dataset.path;

          previewTitle.textContent = name;
          previewDetails.textContent = `Type: ${mime} | Size: ${sizeKB} KB | Uploaded: ${uploadDate}`;
          previewDownload.href = path;

          // Show preview based on mime type
          if (mime.startsWith('image/')) {
            previewContent.innerHTML = `<img src="${path}" alt="${name}" class="max-h-96 mx-auto rounded-lg shadow-lg" />`;
          } else if (mime.startsWith('video/')) {
            previewContent.innerHTML = `<video controls class="max-h-96 mx-auto rounded-lg shadow-lg"><source src="${path}" type="${mime}">Your browser does not support the video tag.</video>`;
          } else if (mime === 'application/pdf') {
            previewContent.innerHTML = `<iframe src="${path}" class="w-full h-96 rounded-lg shadow-lg" aria-label="PDF Preview"></iframe>`;
          } else {
            previewContent.innerHTML = `<p class="text-center text-gray-400">Preview not available for this file type.</p>`;
          }

          previewModal.classList.remove('hidden');
        });
      });

      closePreview.addEventListener('click', () => {
        previewModal.classList.add('hidden');
        previewContent.innerHTML = '';
      });

      previewModal.addEventListener('click', e => {
        if (e.target === previewModal) {
          previewModal.classList.add('hidden');
          previewContent.innerHTML = '';
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    <style>
      @keyframes fade-in-up {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.4s ease-out;
      }
    </style>
  </body>
</html>
